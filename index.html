<!DOCTYPE html>
<html>
<head>
<meta charset='UTF-8'>
<title>CREATIVE ASSET INVENTORY</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="jquery/jquery-1.6.4.min.js"></script>
 <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"
   integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
   crossorigin=""/>
 <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"
   integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
   crossorigin=""></script>
 <script src="randomColor.min.js"></script>
 <script src="spin-js/spin.js"></script>
 <script src="spin-js/jquery.spin.js"></script>
 <script src="http://maps.stamen.com/js/tile.stamen.js"></script>
<script src="MQ-geocode/mq-map.js"></script>
 <script src="MQ-geocode/mq-geocoding.js"></script>
 

	
<link rel="stylesheet" href="cai.css" />



<style>
		
</style>

</head>				
	
<body>

<div id="iconBar"><img src="sf-logo.png" width="120px" style="float:left"><img src="ct-logo.png" height="120px" style="float:left; padding-right:20px;"></div>
<div name="titlebar" >
	<div id="header">
		<h1 style="color:#fff;">CREATIVE ASSETS INVENTORY</h1>
	</div>
</div>
<div class="topnav" id="topMenu">
  <a href="survey.html" style="background-color:#ffffcc">Add an Asset!</a>
  <a href="contact">Get Involved!</a>
  <a href="definitions.html">Definitions</a>
  <a href="about.html">About</a>
    <a href="index.html">Home</a>
  <a href="javascript:void(0);" style="font-size:15px;" class="icon" onclick="loadMenu()">&#9776;</a>
</div>

<div id="spinBox" class='spinner'></div>
<div id="mapdiv" style="width: 100%; height: 500px;"></div>

<script type="text/javascript">

function loadMenu() {
    var x = document.getElementById("topMenu");
    if (x.className === "topnav") {
        x.className += " responsive";
    } else {
        x.className = "topnav";
    }
}

var map = L.map('mapdiv',{
  fullscreenControl: true,
  fullscreenControlOptions: {
    position: 'topleft'
  }
} ).setView([40.526388, -75.060482], 15);

var sidebar;

var stamen = L.tileLayer('http://a.tile.stamen.com/watercolor/{z}/{x}/{y}.png', {attribution: 'uses a <a href="http://stamen.com">stamen</a> basemap'}).addTo(map);

googleSat = L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{
	maxZoom: 20,
    subdomains:['mt0','mt1','mt2','mt3'],
	attribution: 'uses google satellite'
});

var stamenLabels = L.tileLayer('http://a.tile.stamen.com/toner-labels/{z}/{x}/{y}.png', {attribution: 'uses <a href="http://stamen.com">stamen</a> labels'}).addTo(map);

var muniURL = encodeURI("https://creativeassetinventory.carto.com/api/v2/sql?format=GeoJSON&q=SELECT * FROM munis where county = 'HUNTERDON'");
var parcelURL = encodeURI("https://creativeassetinventory.carto.com/api/v2/sql?format=GeoJSON&q=SELECT * FROM parcels where city like '%STOCKTON%' or city like '%FRENCHTOWN%' or city like '%HOLLAND%' or city like '%KINGWOOD%' or city like '%LAMBERTVILLE%' or city like '%CLINTON%' ");
var assetURL = encodeURI("https://creativeassetinventory.carto.com/api/v2/sql?format=GeoJSON&q=SELECT * FROM cai_public");
console.log(parcelURL);

var bases = { "Satellite": googleSat, "Watercolor": stamen};

overlayLayers = {"Street labels": stamenLabels}; 
		<!-- don't forget to add any new layers to the menu! -->		

muniLayer = new L.geoJson();

$.getJSON(muniURL,
            function(data) {
			
	        muniLayer = L.geoJson(data, {
				style: style,
				interactive: false,
				onEachFeature: function (feature, layer) {
					
//					labelText = feature.properties.name;
//					var bounds = layer.getBounds();
//					var center = bounds.getCenter();
//					var divIcon = L.divIcon({ className: "textLabelClass", html: labelText});
//					L.marker(new L.LatLng(center.lat, center.lng), {icon: divIcon }).addTo(map);
				}
				
			});
				overlayLayers["Towns"] = muniLayer;
				muniLayer.addTo(map);
				
				
			});

		
			function style(feature) {
			var randColor = randomColor({hue: 'yellow'});						
			return {
					weight: 6,
					opacity: .3,
					color:'#f69729',
					dashArray: '10,20',
					fillOpacity: 0.1,
					fillColor: randColor,
				};
			}



loadAssets();
				


function getAssetColor(d) {
  switch (d) {
    case 'Space or Facility (includes vacant spaces)':
      return '#b30000';
    case 'Business':
      return '#ff9900';
    case 'Person':
      return '#b2df8a';
    case 'Nonprofit, Educational Institution, or Association':
      return '#ff0066';
    case 'Event':
      return '#fb9a99';
    default:
      return '#FFEDA0';
  }
  }
			
function loadAssets() {
$.getJSON(assetURL,
            function(data) {
			
	        assetLayer = L.geoJson(data, {

			pointToLayer: function(feature, latlng) {
				return new L.CircleMarker(latlng, {
				radius: 10,
				weight:2,
				color:"#fff",
				opacity:.7,
				fillOpacity: 0.7,
				fillColor:getAssetColor(feature.properties.a_type)
				});
				},
			
				interactive: true,
				onEachFeature: function (feature, layer) {
					lat = feature.properties.lat;
					lng = feature.properties.lng;
					var popupContent = "<h1>"+ feature.properties.a_name.toUpperCase() + "</h1>" +
						"<h4>" + feature.properties.address.toUpperCase() + "</h4>"+
						"<div height='200px' width='250px' style='overflow-x:hidden'>" +
						"<img src='" + feature.properties.photolink + "' height='200px')>" + 
						"</div>" +
						feature.properties.a_desc + "<br>" + 
						"<hr>" +
						"<b>" + feature.properties.a_type + "</b>"
					;
					layer.bindPopup(popupContent, {'maxWidth':'260', 'keepInView': 'true', 'color':getAssetColor(feature.properties.a_type)});

				}
				
			});
				overlayLayers["Assets"] = assetLayer;
				assetLayer.addTo(map);
				L.control.layers(bases, overlayLayers).addTo(map);
				console.log("loaded assets");
				
			});

}
			
 
			
map.on('click', function (e) {
	lat = e.latlng.lat;
	lng = e.latlng.lng;
	var popup = new L.popup({'max-width':'200px'}).setLatLng(e.latlng);
    geocode = MQ.geocode().reverse(e.latlng).on('success', function(e) {
			console.log(lat, lng);
			locResult = geocode.describeLocation(e.result.best);
			addPlace = locResult.indexOf('<');
			console.log(addPlace);
			addStripped=locResult.substr(0,addPlace);
			restStripped=locResult.substr(addPlace+1,locResult.length);
			cityPos=restStripped.indexOf(',');
			cityStripped=restStripped.substr(4,cityPos-4);
			stateStripped=restStripped.substr(cityPos+2,2);
			console.log(addStripped);
						console.log(restStripped);
						console.log(cityStripped);
						console.log(stateStripped);
			var stateLabel ='';
			if (stateStripped == 'NJ') {stateLabel = 'New Jersey';}
			else if (stateStripped=='PA'){stateLabel = 'Pennsylvania';}
			jotLink = "https://form.jotform.us/72586059140155?addressOr[addr_line1]="+ addStripped + "&addressOr[city]=" + cityStripped + "&addressOr[state]=" + stateLabel + "&lat=" + lat + "&lng=" + lng;
;
			popupContent = "<b>" + locResult + "</b>" + "<hr>" +
				"<h1><a style='text-decoration:none' target='blank' href='"+ jotLink + "'>ADD AN ASSET!</a></h1>" ;
	        popup.setContent(popupContent);
		});
	popup.openOn(map);
});


			

	
</script> 
  

</body>
</html>
